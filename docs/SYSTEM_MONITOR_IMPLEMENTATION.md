# 系统监控功能实现文档

## 实施时间
2025-11-14

## 实施概述
为母婴商城管理后台添加完整的系统监控功能，实时监控服务器性能、数据库状态、Redis状态和API调用统计。

---

## 设计原则

遵循 **AURA-X-KYS (KISS/YAGNI/SOLID)** 协议：

- **KISS (Keep It Simple, Stupid)**: 界面简洁直观，一目了然
- **YAGNI (You Aren't Gonna Need It)**: 只实现必要的监控功能，避免过度设计
- **SOLID**: 组件结构清晰，职责单一，易于维护和扩展

---

## 后端API

后端已有完整的监控API（位于 `SystemMonitorController.java`）：

### 主要接口

| 接口 | 方法 | 说明 |
|------|------|------|
| `/admin/system/monitor/metrics` | GET | 获取完整的系统监控指标 |
| `/admin/system/monitor/health` | GET | 获取系统健康状态 |
| `/admin/system/monitor/server` | GET | 获取服务器性能指标 |
| `/admin/system/monitor/database` | GET | 获取数据库监控指标 |
| `/admin/system/monitor/redis` | GET | 获取Redis监控指标 |
| `/admin/system/monitor/api-statistics` | GET | 获取API调用统计 |
| `/admin/system/monitor/api-statistics/reset` | POST | 重置API统计数据 |
| `/admin/system/monitor/database/version` | GET | 获取数据库版本 |
| `/admin/system/monitor/redis/ping` | GET | 检查Redis连接状态 |

### 监控组件

后端包含以下监控组件（位于 `monitor/` 目录）：

- **ServerMonitor**: 服务器性能监控（CPU、内存、磁盘、JVM）
- **DatabaseMonitor**: 数据库监控（连接池、查询统计、慢查询）
- **RedisMonitor**: Redis监控（内存、命中率、键空间）
- **ApiStatisticsMonitor**: API调用统计
- **CacheMonitor**: 缓存监控

---

## 前端实现

### 文件结构

```
muying-admin/
├── src/
│   ├── types/
│   │   └── monitor.ts                    # 监控类型定义
│   ├── lib/
│   │   └── api/
│   │       └── monitor.ts                # 监控API客户端
│   ├── components/
│   │   ├── ui/
│   │   │   └── card.tsx                  # Card组件（新增）
│   │   └── monitor/
│   │       └── ProgressRing.tsx          # 进度环组件
│   ├── views/
│   │   └── monitor/
│   │       └── SystemMonitorView.tsx     # 系统监控视图
│   └── app/
│       └── settings/
│           └── monitor/
│               └── page.tsx              # 监控页面路由
```

### 核心组件

#### 1. ProgressRing 组件

**功能**: 可视化显示百分比进度的圆环组件

**特性**:
- 自适应颜色（根据进度自动选择颜色）
- 平滑动画过渡
- 可自定义大小、颜色、标签
- 支持显示/隐藏百分比

**使用示例**:
```tsx
<ProgressRing
  progress={75}
  size={120}
  label="CPU使用率"
/>
```

#### 2. SystemMonitorView 组件

**功能**: 系统监控主视图，展示所有监控数据

**核心功能**:
- ✅ 实时数据刷新（默认30秒）
- ✅ 手动刷新
- ✅ 暂停/恢复自动刷新
- ✅ 系统健康状态总览
- ✅ 服务器性能监控
- ✅ 数据库监控
- ✅ Redis监控
- ✅ API调用统计

**布局结构**:
```
┌─────────────────────────────────────────┐
│ 顶部操作栏（刷新按钮、自动刷新开关）      │
├─────────────────────────────────────────┤
│ 系统健康状态总览                         │
│ ┌──────┬──────┬──────┬──────┐          │
│ │数据库│Redis │磁盘  │内存  │          │
│ └──────┴──────┴──────┴──────┘          │
├─────────────────────────────────────────┤
│ 服务器性能                               │
│ ┌──────┬──────┬──────┬──────┐          │
│ │ CPU  │内存  │磁盘  │ JVM  │          │
│ │ 进度环│进度环│进度环│进度环│          │
│ └──────┴──────┴──────┴──────┘          │
│ 运行时间 | 线程数 | 峰值线程             │
├─────────────────────────────────────────┤
│ 数据库监控        │ Redis监控           │
│ ├─────────────┤ ├─────────────┤       │
│ │连接池使用率   │ │缓存命中率     │       │
│ │查询统计       │ │内存使用       │       │
│ │慢查询         │ │键空间信息     │       │
│ └─────────────┘ └─────────────┘       │
├─────────────────────────────────────────┤
│ API调用统计                              │
│ 总请求 | 成功 | 失败 | 平均响应时间      │
│ 最慢的API列表                            │
└─────────────────────────────────────────┘
```

---

## 数据可视化

### 1. 进度环（Progress Ring）

用于显示百分比数据，如：
- CPU使用率
- 内存使用率
- 磁盘使用率
- JVM内存使用率

**颜色规则**:
- 0-60%: 绿色（正常）
- 60-80%: 蓝色（良好）
- 80-90%: 橙色（警告）
- 90-100%: 红色（危险）

### 2. 进度条（Progress Bar）

用于显示线性进度，如：
- 数据库连接池使用率
- Redis缓存命中率

### 3. 状态徽章（Badge）

用于显示组件健康状态：
- **UP**: 绿色徽章（正常）
- **DOWN**: 红色徽章（异常）
- **WARNING**: 黄色徽章（警告）

### 4. 统计卡片

用于显示关键指标：
- 渐变背景
- 大号数字
- 图标装饰

---

## 功能特性

### 1. 自动刷新

- 默认每30秒自动刷新一次
- 可通过按钮暂停/恢复自动刷新
- 显示最后更新时间

### 2. 手动刷新

- 点击刷新按钮立即更新数据
- 刷新时显示加载动画

### 3. 响应式布局

- 桌面端：4列网格布局
- 平板端：2列网格布局
- 手机端：单列布局

### 4. 数据格式化

- 字节数自动转换为人类可读格式（B, KB, MB, GB, TB）
- 数字添加千分位分隔符
- 百分比保留两位小数

---

## 监控指标说明

### 服务器性能

| 指标 | 说明 | 正常范围 |
|------|------|----------|
| CPU使用率 | 当前CPU使用百分比 | < 80% |
| 内存使用率 | 物理内存使用百分比 | < 80% |
| 磁盘使用率 | 磁盘空间使用百分比 | < 80% |
| JVM内存 | Java虚拟机内存使用率 | < 80% |
| 系统负载 | 系统平均负载 | < CPU核心数 |
| 线程数 | 当前活跃线程数 | - |

### 数据库监控

| 指标 | 说明 |
|------|------|
| 连接池使用率 | 活跃连接数 / 最大连接数 |
| 总查询数 | 累计执行的SQL查询数 |
| 慢查询数 | 执行时间超过阈值的查询数 |
| 平均查询时间 | SQL查询的平均执行时间 |
| 数据库大小 | 数据库占用的磁盘空间 |

### Redis监控

| 指标 | 说明 |
|------|------|
| 缓存命中率 | 命中次数 / (命中次数 + 未命中次数) |
| 已用内存 | Redis占用的内存大小 |
| 连接客户端数 | 当前连接的客户端数量 |
| 总键数 | Redis中存储的键总数 |
| 每秒操作数 | Redis每秒处理的命令数 |

### API统计

| 指标 | 说明 |
|------|------|
| 总请求数 | API接收的总请求数 |
| 成功请求数 | 返回2xx状态码的请求数 |
| 失败请求数 | 返回4xx/5xx状态码的请求数 |
| 成功率 | 成功请求数 / 总请求数 |
| 平均响应时间 | API响应的平均时间 |

---

## 使用指南

### 访问监控页面

1. 登录管理后台
2. 点击侧边栏"系统配置"菜单
3. 选择"系统监控"子菜单

### 查看监控数据

- **系统健康状态**: 顶部卡片显示各组件的健康状态
- **服务器性能**: 通过进度环直观查看CPU、内存、磁盘使用情况
- **数据库监控**: 查看连接池使用率和查询统计
- **Redis监控**: 查看缓存命中率和内存使用
- **API统计**: 查看请求量和响应时间

### 刷新数据

- **自动刷新**: 默认开启，每30秒自动更新
- **手动刷新**: 点击右上角"刷新"按钮
- **暂停刷新**: 点击"自动刷新"按钮切换状态

---

## 性能优化

### 1. 数据缓存

- 使用React状态管理缓存监控数据
- 避免频繁的API调用

### 2. 按需加载

- 只在访问监控页面时加载数据
- 离开页面时清理定时器

### 3. 防抖节流

- 手动刷新按钮添加防抖处理
- 避免短时间内重复请求

---

## 故障排查

### 问题1: 监控数据加载失败

**可能原因**:
- 后端服务未启动
- 认证token过期
- 网络连接问题

**解决方案**:
1. 检查后端服务是否正常运行
2. 重新登录获取新token
3. 检查网络连接和代理配置

### 问题2: 数据显示异常

**可能原因**:
- 后端返回数据格式不匹配
- 类型定义不一致

**解决方案**:
1. 检查后端API返回的数据结构
2. 更新前端类型定义
3. 查看浏览器控制台错误信息

### 问题3: 自动刷新不工作

**可能原因**:
- 定时器被清理
- 组件卸载

**解决方案**:
1. 检查自动刷新开关状态
2. 重新进入监控页面
3. 手动点击刷新按钮

---

## 后续优化建议

### 1. 历史数据图表

- 添加时间序列图表
- 显示CPU、内存使用趋势
- 支持自定义时间范围

### 2. 告警功能

- 设置监控阈值
- 超过阈值时发送告警通知
- 支持邮件/短信/WebSocket推送

### 3. 导出功能

- 导出监控报告（PDF/Excel）
- 支持自定义报告模板
- 定时生成报告

### 4. 更多监控指标

- 网络流量监控
- 消息队列监控（RabbitMQ）
- 搜索引擎监控（Elasticsearch）

### 5. 性能优化

- 使用WebSocket实时推送数据
- 添加数据压缩
- 实现增量更新

---

## 技术栈

- **前端框架**: Next.js 14 + React 18
- **UI组件**: shadcn/ui + Tailwind CSS
- **状态管理**: React Hooks (useState, useEffect)
- **HTTP客户端**: Axios
- **图标库**: Lucide React
- **动画**: Framer Motion

---

## 相关文件

### 前端文件
- `src/types/monitor.ts` - 监控类型定义
- `src/lib/api/monitor.ts` - 监控API客户端
- `src/components/monitor/ProgressRing.tsx` - 进度环组件
- `src/components/ui/card.tsx` - Card组件
- `src/views/monitor/SystemMonitorView.tsx` - 系统监控视图
- `src/app/settings/monitor/page.tsx` - 监控页面路由
- `src/components/layout/AdminDashboard.tsx` - 主布局（已更新）

### 后端文件
- `controller/SystemMonitorController.java` - 监控控制器
- `service/SystemMonitorService.java` - 监控服务
- `dto/SystemMetricsDTO.java` - 监控数据传输对象
- `monitor/ServerMonitor.java` - 服务器监控
- `monitor/DatabaseMonitor.java` - 数据库监控
- `monitor/RedisMonitor.java` - Redis监控
- `monitor/ApiStatisticsMonitor.java` - API统计监控

---

## 总结

本次实施完成了系统监控功能的核心模块，遵循了KISS、YAGNI、SOLID原则：

✅ **简洁直观** - 单页面展示所有关键指标，一目了然
✅ **功能实用** - 只实现必要的监控功能，避免过度设计
✅ **结构清晰** - 组件职责单一，易于维护和扩展
✅ **性能优化** - 合理的刷新策略，避免资源浪费
✅ **用户体验** - 响应式布局，支持自动/手动刷新

系统监控功能为管理员提供了实时的系统运行状态，有助于及时发现和解决问题，保障系统稳定运行。

---

**实施完成时间**: 2025-11-14
**遵循协议**: AURA-X-KYS (KISS/YAGNI/SOLID)
**核心原则**: 简洁、实用、可维护
